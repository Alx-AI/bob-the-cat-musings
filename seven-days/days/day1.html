<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Day 1: Spectral Canvas — 7 Days of Sound & Light</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;overflow:hidden;font-family:'JetBrains Mono','Courier New',monospace}
canvas{display:block;position:fixed;top:0;left:0;cursor:crosshair}
#ui{position:fixed;z-index:10;pointer-events:none}
#info{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
  font-size:8px;color:#888;letter-spacing:0.12em;z-index:10;pointer-events:none;
  transition:opacity 3s;text-align:center}
#info.fade{opacity:0}
#title{position:fixed;top:16px;left:20px;font-size:8px;color:#777;letter-spacing:0.15em;z-index:10;pointer-events:none}
#controls{position:fixed;top:16px;right:20px;font-size:8px;color:#777;letter-spacing:0.08em;z-index:10;display:flex;gap:12px}
#controls button{font-family:inherit;font-size:8px;background:none;border:1px solid #333;
  color:#888;padding:3px 10px;cursor:pointer;letter-spacing:0.08em;pointer-events:auto;transition:all 0.2s}
#controls button:hover{border-color:#777;color:#ccc}
#controls button.active{border-color:rgba(220,190,120,0.4);color:rgb(220,190,120)}
#mode{position:fixed;bottom:16px;right:20px;font-size:7px;color:#777;letter-spacing:0.1em;z-index:10;pointer-events:none}
.sig{position:fixed;bottom:8px;left:16px;font-size:6px;color:rgba(100,100,100,0.15);z-index:10;pointer-events:none}

/* Comment panel */
#commentToggle{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
  font-size:8px;color:#777;letter-spacing:0.1em;z-index:20;cursor:pointer;
  background:none;border:1px solid #333;padding:4px 14px;font-family:inherit;transition:all 0.3s;margin-top:20px}
#commentToggle:hover{border-color:#777;color:#ccc}
#commentPanel{position:fixed;bottom:0;left:0;right:0;z-index:15;
  background:rgba(0,0,0,0.95);border-top:1px solid #333;
  backdrop-filter:blur(12px);padding:16px 20px;
  transform:translateY(100%);transition:transform 0.3s;max-height:40vh;overflow-y:auto}
#commentPanel.open{transform:translateY(0)}
#commentPanel .cp-title{font-size:9px;color:#999;letter-spacing:0.12em;margin-bottom:10px}
#commentPanel textarea{width:100%;max-width:500px;height:60px;background:#000;border:1px solid #333;
  color:#ccc;font-family:inherit;font-size:9px;padding:8px;resize:none;outline:none;letter-spacing:0.04em}
#commentPanel textarea:focus{border-color:#777}
#commentPanel .cp-submit{font-family:inherit;font-size:8px;background:none;border:1px solid #333;
  color:#888;padding:4px 14px;cursor:pointer;margin-top:6px;letter-spacing:0.08em;transition:all 0.2s}
#commentPanel .cp-submit:hover{border-color:rgba(220,190,120,0.4);color:rgb(220,190,120)}
#commentPanel .cp-name{width:200px;background:#000;border:1px solid #333;
  color:#ccc;font-family:inherit;font-size:9px;padding:4px 8px;outline:none;margin-right:8px;letter-spacing:0.04em}
#commentPanel .cp-row{display:flex;align-items:center;gap:8px;margin-top:6px}
#comments{margin-top:12px}
#comments .comment{margin-bottom:8px;padding:6px 0;border-bottom:1px solid #1a1a1a}
#comments .comment .c-name{font-size:8px;color:#999;letter-spacing:0.08em}
#comments .comment .c-time{font-size:7px;color:#555;margin-left:8px}
#comments .comment .c-text{font-size:9px;color:#ccc;margin-top:3px;line-height:1.5;letter-spacing:0.03em}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="title">day 1 · spectral canvas</div>
<div id="controls">
  <button id="btnFree" class="active">free</button>
  <button id="btnPenta">pentatonic</button>
  <button id="btnHarm">harmonic</button>
  <button id="btnClear">clear</button>
</div>
<div id="info">draw to paint with sound · x = pitch · y = brightness · speed = attack<br>click mode buttons to change pitch quantization</div>
<div id="mode">free pitch</div>
<button id="commentToggle">comments</button>
<div id="commentPanel">
  <div class="cp-title">leave feedback</div>
  <textarea id="commentText" placeholder="what did you think? what should day 2 be?"></textarea>
  <div class="cp-row">
    <input class="cp-name" id="commentName" placeholder="name (optional)">
    <button class="cp-submit" id="commentSubmit">send</button>
  </div>
  <div id="comments"></div>
</div>
<div class="sig">7 days of sound & light · conjecture_</div>

<script>
// ═══════════════════════════════════════════════
// SPECTRAL CANVAS — Day 1
// 
// Draw with sound and light. Every stroke is a voice.
// X = pitch. Y = filter brightness. Speed = attack shape.
// Strokes glow and decay. The image IS the score.
//
// Lineage: Murzin's ANS (1958) → Xenakis's UPIC (1977) → 
// MetaSynth → this.
// ═══════════════════════════════════════════════

const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
let W,H;
function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;}
resize();window.addEventListener('resize',resize);

// ── AUDIO ──
let ac=null;
let masterGain,reverbNode,reverbGain,compressor;

function initAudio(){
  if(ac)return;
  ac=new(window.AudioContext||window.webkitAudioContext)();
  compressor=ac.createDynamicsCompressor();
  compressor.threshold.value=-8;compressor.ratio.value=6;
  compressor.attack.value=0.003;compressor.release.value=0.1;
  masterGain=ac.createGain();masterGain.gain.value=0.4;
  
  // Cathedral reverb
  reverbGain=ac.createGain();reverbGain.gain.value=0.35;
  const rvLen=ac.sampleRate*5;
  const rvBuf=ac.createBuffer(2,rvLen,ac.sampleRate);
  for(let ch=0;ch<2;ch++){
    const d=rvBuf.getChannelData(ch);
    for(let i=0;i<rvLen;i++){
      d[i]=(Math.random()*2-1)*Math.pow(1-i/rvLen,2)*(1+Math.sin(i/ac.sampleRate*0.3)*0.2);
    }
  }
  reverbNode=ac.createConvolver();reverbNode.buffer=rvBuf;
  
  masterGain.connect(compressor);
  masterGain.connect(reverbGain);reverbGain.connect(reverbNode);reverbNode.connect(compressor);
  compressor.connect(ac.destination);
}

// ── PITCH MODES ──
let pitchMode='free'; // free, pentatonic, harmonic
const PENTA_RATIOS=[1, 9/8, 5/4, 3/2, 5/3]; // major pentatonic in JI
const HARM_RATIOS=[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16];
const BASE_FREQ=65.41; // C2
const MAX_FREQ=4186; // C8

function xToFreq(nx){
  // nx: 0-1 normalized x position
  const rawFreq=BASE_FREQ*Math.pow(MAX_FREQ/BASE_FREQ,nx);
  
  if(pitchMode==='free')return rawFreq;
  
  if(pitchMode==='pentatonic'){
    // Find nearest pentatonic note across octaves
    let best=rawFreq,bestDist=Infinity;
    for(let oct=0;oct<7;oct++){
      const octFreq=BASE_FREQ*Math.pow(2,oct);
      for(const r of PENTA_RATIOS){
        const f=octFreq*r;
        const dist=Math.abs(Math.log2(f/rawFreq));
        if(dist<bestDist){bestDist=dist;best=f;}
      }
    }
    return best;
  }
  
  if(pitchMode==='harmonic'){
    // Snap to harmonic series of fundamental
    const fund=BASE_FREQ;
    const harmonic=Math.round(rawFreq/fund);
    return fund*Math.max(1,Math.min(harmonic,32));
  }
  
  return rawFreq;
}

function freqToColor(freq,brightness){
  // conjecture_ palette: grayscale base with earned gold warmth
  // Low freq = warm gold, high freq = cool white/silver
  const t=Math.log2(freq/BASE_FREQ)/Math.log2(MAX_FREQ/BASE_FREQ);
  // Gold (220,190,120) → white (220,220,220) across frequency
  const r=Math.round(220+t*0);
  const g=Math.round(190+t*30);
  const b=Math.round(120+t*100);
  return {r,g,b};
}

// ── STROKES ──
// Each stroke is a collection of sample points with audio voices
const strokes=[];
const MAX_STROKES=60;

class Stroke{
  constructor(){
    this.points=[];
    this.voices=[];
    this.life=1;
    this.decay=0.0003; // ~55 seconds full decay
    this.born=performance.now();
    this.maxLife=20000; // start fading after 20s
  }
  
  addPoint(x,y,speed){
    initAudio();
    const nx=x/W, ny=y/H;
    const freq=xToFreq(nx);
    const brightness=1-ny; // top=bright, bottom=dark
    
    // Don't add points too close together
    if(this.points.length>0){
      const last=this.points[this.points.length-1];
      const dx=x-last.x,dy=y-last.y;
      if(Math.sqrt(dx*dx+dy*dy)<4)return;
    }
    
    this.points.push({x,y,nx,ny,freq,brightness,speed,size:2+speed*8,alpha:1});
    
    // Create voice — warm detuned oscillators with formant character
    this._createVoice(freq,brightness,speed,nx);
  }
  
  _createVoice(freq,brightness,speed,pan){
    if(!ac)return;
    const t=ac.currentTime;
    const nodes=[];
    
    // Attack time based on drawing speed — fast strokes = sharp attack
    const atkTime=Math.max(0.005,0.15-speed*0.12);
    const vel=0.3+brightness*0.5;
    
    // 4 detuned oscillators for warmth
    const detunes=[-5,-1.5,1.5,5];
    const voiceGain=ac.createGain();voiceGain.gain.setValueAtTime(0,t);
    voiceGain.gain.linearRampToValueAtTime(vel*0.015,t+atkTime);
    
    // Filter — y position controls brightness
    const flt=ac.createBiquadFilter();flt.type='lowpass';
    flt.frequency.value=200+Math.pow(brightness,2)*8000;
    flt.Q.value=0.5+brightness*2;
    
    detunes.forEach(det=>{
      const o=ac.createOscillator();
      // Custom wave — hollow, vocal-ish
      const real=new Float32Array([0,0,1,0,0.5,0,0.2,0,0.08,0,0.03]);
      const imag=new Float32Array(real.length);
      o.setPeriodicWave(ac.createPeriodicWave(real,imag));
      o.frequency.value=freq+det;
      // Slow drift for life
      const lfo=ac.createOscillator();lfo.type='sine';
      lfo.frequency.value=0.1+Math.random()*0.15;
      const lfoG=ac.createGain();lfoG.gain.value=freq*0.002;
      lfo.connect(lfoG);lfoG.connect(o.frequency);
      lfo.start(t);
      
      o.connect(flt);o.start(t);
      nodes.push(o,lfo,lfoG);
    });
    
    // Panning based on x position
    const panner=ac.createStereoPanner();
    panner.pan.value=Math.max(-1,Math.min(1,(pan-0.5)*1.6));
    
    flt.connect(voiceGain);voiceGain.connect(panner);panner.connect(masterGain);
    
    this.voices.push({gain:voiceGain,nodes,flt,panner,baseVel:vel,freq});
  }
  
  update(dt){
    const age=performance.now()-this.born;
    if(age>this.maxLife){
      this.life-=this.decay*dt*60;
    }
    
    // Fade audio with visual
    for(const v of this.voices){
      if(v.gain.gain.value>0.0001){
        v.gain.gain.setTargetAtTime(v.baseVel*0.015*Math.max(this.life,0),ac.currentTime,0.5);
      }
    }
    
    // Update point alphas
    for(const p of this.points){
      p.alpha=Math.max(this.life,0);
      p.size*=0.9998; // very slow shrink
    }
    
    return this.life>0.01;
  }
  
  kill(){
    for(const v of this.voices){
      try{
        v.gain.gain.setTargetAtTime(0,ac.currentTime,0.05);
        setTimeout(()=>{
          for(const n of v.nodes)try{n.stop();}catch(e){}
        },500);
      }catch(e){}
    }
  }
}

// ── INPUT ──
let drawing=false;
let currentStroke=null;
let lastX=0,lastY=0,lastTime=0;

function startDraw(x,y){
  initAudio();
  drawing=true;
  currentStroke=new Stroke();
  lastX=x;lastY=y;lastTime=performance.now();
  currentStroke.addPoint(x,y,0.5);
  strokes.push(currentStroke);
  if(strokes.length>MAX_STROKES){
    const old=strokes.shift();old.kill();
  }
  if(frame>100)document.getElementById('info').classList.add('fade');
}

function moveDraw(x,y){
  if(!drawing||!currentStroke)return;
  const now=performance.now();
  const dt=Math.max(now-lastTime,1);
  const dx=x-lastX,dy=y-lastY;
  const speed=Math.min(Math.sqrt(dx*dx+dy*dy)/dt*2,1);
  currentStroke.addPoint(x,y,speed);
  lastX=x;lastY=y;lastTime=now;
}

function endDraw(){drawing=false;currentStroke=null;}

canvas.addEventListener('mousedown',e=>startDraw(e.clientX,e.clientY));
canvas.addEventListener('mousemove',e=>{if(drawing)moveDraw(e.clientX,e.clientY);});
canvas.addEventListener('mouseup',endDraw);
canvas.addEventListener('mouseleave',endDraw);

canvas.addEventListener('touchstart',e=>{e.preventDefault();const t=e.touches[0];startDraw(t.clientX,t.clientY);},{passive:false});
canvas.addEventListener('touchmove',e=>{e.preventDefault();const t=e.touches[0];moveDraw(t.clientX,t.clientY);},{passive:false});
canvas.addEventListener('touchend',e=>{e.preventDefault();endDraw();},{passive:false});

// ── CONTROLS ──
const btnFree=document.getElementById('btnFree');
const btnPenta=document.getElementById('btnPenta');
const btnHarm=document.getElementById('btnHarm');
const btnClear=document.getElementById('btnClear');
const modeLabel=document.getElementById('mode');

function setMode(m){
  pitchMode=m;
  [btnFree,btnPenta,btnHarm].forEach(b=>b.classList.remove('active'));
  if(m==='free'){btnFree.classList.add('active');modeLabel.textContent='free pitch';}
  if(m==='pentatonic'){btnPenta.classList.add('active');modeLabel.textContent='pentatonic · C major';}
  if(m==='harmonic'){btnHarm.classList.add('active');modeLabel.textContent='harmonic series · C2';}
}
btnFree.onclick=()=>setMode('free');
btnPenta.onclick=()=>setMode('pentatonic');
btnHarm.onclick=()=>setMode('harmonic');
btnClear.onclick=()=>{strokes.forEach(s=>s.kill());strokes.length=0;};

// ── COMMENT PANEL ──
const commentToggle=document.getElementById('commentToggle');
const commentPanel=document.getElementById('commentPanel');
let panelOpen=false;
commentToggle.onclick=()=>{panelOpen=!panelOpen;commentPanel.classList.toggle('open',panelOpen);};

// ── COMMENTS — Neon Postgres via HTTP SQL API ──
const NEON_SQL='https://ep-snowy-darkness-aivqbziz-pooler.c-4.us-east-1.aws.neon.tech/sql';
const NEON_CONN='postgresql://comments_public:pub_7days_2026@ep-snowy-darkness-aivqbziz-pooler.c-4.us-east-1.aws.neon.tech/neondb';
const DAY_NUM=1;

async function neonQuery(query,params){
  const r=await fetch(NEON_SQL,{
    method:'POST',
    headers:{'Content-Type':'application/json','Neon-Connection-String':NEON_CONN},
    body:JSON.stringify({query,params:params||[]})
  });
  return r.json();
}

async function loadComments(){
  try{
    const r=await neonQuery('SELECT name, text, created_at FROM comments WHERE day = $1 ORDER BY created_at DESC LIMIT 100',[DAY_NUM]);
    if(r.rows)r.rows.forEach(c=>addCommentToDOM(c.name,c.text,c.created_at));
  }catch(e){console.error('Failed to load comments:',e);}
}

document.getElementById('commentSubmit').onclick=async()=>{
  const text=document.getElementById('commentText').value.trim();
  const name=document.getElementById('commentName').value.trim()||'anon';
  if(!text)return;
  const btn=document.getElementById('commentSubmit');
  btn.textContent='sending...';btn.disabled=true;
  try{
    // Sanitize — strip HTML
    const cleanText=text.replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const cleanName=name.replace(/</g,'&lt;').replace(/>/g,'&gt;').slice(0,50);
    await neonQuery('INSERT INTO comments (day, name, text) VALUES ($1, $2, $3)',[DAY_NUM,cleanName,cleanText]);
    addCommentToDOM(cleanName,cleanText,new Date().toISOString());
    document.getElementById('commentText').value='';
  }catch(e){console.error('Failed to post comment:',e);}
  btn.textContent='send';btn.disabled=false;
};

function addCommentToDOM(name,text,time){
  const el=document.createElement('div');el.className='comment';
  const d=new Date(time);
  const timeStr=d.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' '+d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
  el.innerHTML=`<span class="c-name">${name}</span><span class="c-time">${timeStr}</span><div class="c-text">${text}</div>`;
  document.getElementById('comments').prepend(el);
}

// Load existing comments on page load
loadComments();

// ── RENDER ──
let frame=0;

function render(){
  frame++;
  ctx.fillStyle='rgba(0,0,0,0.06)'; // slow fade — trails persist
  ctx.fillRect(0,0,W,H);
  
  // Update and draw strokes
  for(let i=strokes.length-1;i>=0;i--){
    const s=strokes[i];
    const alive=s.update(1);
    if(!alive){s.kill();strokes.splice(i,1);continue;}
    
    // Draw stroke points
    for(const p of s.points){
      if(p.alpha<0.01)continue;
      
      const c=freqToColor(p.freq,p.brightness);
      const size=p.size*p.alpha;
      const alpha=p.alpha;
      
      // Outer glow
      if(size>1.5){
        const glowSize=size*4;
        ctx.fillStyle=`rgba(${c.r},${c.g},${c.b},${alpha*0.08})`;
        ctx.beginPath();ctx.arc(p.x,p.y,glowSize,0,Math.PI*2);ctx.fill();
      }
      
      // Mid glow
      ctx.fillStyle=`rgba(${c.r},${c.g},${c.b},${alpha*0.2})`;
      ctx.beginPath();ctx.arc(p.x,p.y,size*2,0,Math.PI*2);ctx.fill();
      
      // Core — bright center, brightness controls intensity
      const coreAlpha=alpha*(0.5+p.brightness*0.5);
      const coreBright=0.6+p.brightness*0.4;
      ctx.fillStyle=`rgba(${Math.round(c.r*coreBright)},${Math.round(c.g*coreBright)},${Math.round(c.b*coreBright)},${coreAlpha})`;
      ctx.beginPath();ctx.arc(p.x,p.y,size*0.6,0,Math.PI*2);ctx.fill();
    }
  }
  
  requestAnimationFrame(render);
}
render();
</script>
</body>
</html>
